#!/usr/bin/env bash

#
# git-feature
#

_get_jira_ticket_for_description () {
  name=$2
  pass=$3
  if [[ -z "$2" && -z "$3" ]]; then
    if ! [[ -z ${USERNAME+x} || -z ${PASSWORD+x} ]]; then
      name=$USERNAME
      pass=$PASSWORD
    fi
  fi
  if ! [[ -z "$name" || -z "$pass" ]]; then
    ticket=$(curl -s -u $name:$pass https://jira.fastspring.com/rest/api/2/issue/$1)
    summary=$(printf "%s" "$ticket" | jq -M -r '.fields.summary')
    [[ ! -z "$summary" ]] && git config branch.$1.description "$summary"
  fi
}

if [[ $# -eq 0 ]]; then
  printf "Usage: git feature <branch> [<username> <password>]\n"
elif [[ -z "$(type -t jq)" ]]; then
  printf "This script requires jq to be installed in order to parse the JSON response from JIRA.\n"
else
  if [[ ! -z "$(git branch --all | grep $1)" ]]; then
    if [[ -z "$(git config branch.$1.description)" ]]; then
      read -e -r -p "$1 already exists but has no description. Try to get its JIRA summary? [y/n]: " choice && printf "\n"
      if [[ "$choice" == "y" ]]; then
        _get_jira_ticket_for_description $1 $2 $3
      fi
    else
      printf "$1 has already been created and has a description.\n"
    fi
  else
    git checkout -b "$1" origin/master
    git push -u origin "$1"
    _get_jira_ticket_for_description $1 $2 $3
  fi
  while read -r branch; do
    clean_branch_name=${branch//\*\ /}
    description=$(git config branch.$clean_branch_name.description)
    if [[ "${branch::1}" == "*" ]]; then
      printf "* \e[38;5;10m$clean_branch_name\e[0m \e[38;5;252m$description\e[0m\n"
    else
      printf "  $branch \e[38;5;252m$description\e[0m\n"
    fi
  done <<< "$(git branch --list)"
  printf "\n"
fi

