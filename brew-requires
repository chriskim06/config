#!/usr/bin/env bash

#
# brew-requires
#

_brew_requires_thread () {
  if [[ $# -ne 2 ]]; then
    return 0
  fi
  info=$(brew info $1 | sed -e '1,/==> Dependencies/ d' -e '/==> Options/,$ d' -e '/==> Caveats/,$ d' | grep "$2")
  if [[ ! -z $info ]]; then
    IFS=$'\n'
    deps=($info)
    groups="\e[1;38;5;9m"
    for i in "${deps[@]}"; do
      groups="$groups${i%%:*}, "
    done
    printf "\e[1;38;5;15m$1\e[0m \e[1;38;5;15m- ${groups%, }\e[0m\n"
  fi
}
export -f _brew_requires_thread

if [[ $# -ne 1 ]]; then
  printf "usage: brew requires <package name>\n"
  return 0
fi
printf "Installed formulae that depend on \e[1;38;5;47m$1\e[0m...\n"
parallel --no-notice -k _brew_requires_thread ::: $(\ls $(brew --cellar)) ::: $1
